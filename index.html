<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP RT 04 - Digital Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f8fafc;
            --sidebar: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); display: flex; flex-direction: column; min-height: 100vh; }

        /* Mobile Layout */
        header { background: var(--sidebar); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        
        nav { background: var(--sidebar); color: white; position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; padding: 0.8rem 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        nav a { color: #94a3b8; text-decoration: none; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        nav a.active { color: white; }
        nav i { font-size: 1.2rem; }

        main { padding: 1rem; padding-bottom: 80px; flex: 1; width: 100%; max-width: 1200px; margin: 0 auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .active-section { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cards & UI */
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .grid-charts { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { .grid-charts { grid-template-columns: 1fr 1fr; } }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; }

        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 6px; }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; }
        .badge-lunas { background: #dcfce7; color: #166534; }
        .badge-belum { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<header>
    <h3>ERP RT 04</h3>
    <div id="sync-status"><i class="fas fa-cloud"></i> Terhubung</div>
</header>

<main>
    <section id="dashboard" class="section active-section">
        <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
        <div class="grid-charts">
            <div class="card"><canvas id="barChart"></canvas></div>
            <div class="card"><canvas id="pieChart"></canvas></div>
            <div class="card"><canvas id="lineChart"></canvas></div>
        </div>
    </section>

    <section id="warga" class="section">
        <div class="card">
            <h2><i class="fas fa-users"></i> Data Warga</h2>
            <input type="file" id="importWarga" style="display:none" accept=".json">
            <button class="btn btn-success" onclick="document.getElementById('importWarga').click()">
                <i class="fas fa-file-import"></i> Impor JSON
            </button>
            <form id="formWarga">
                <input type="text" id="wNama" placeholder="Nama Lengkap" required>
                <input type="text" id="wAlamat" placeholder="Alamat (No Rumah)" required>
                <select id="wStatus">
                    <option value="Tetap">Tetap</option>
                    <option value="Kontrak">Kontrak</option>
                </select>
                <input type="tel" id="wTelp" placeholder="No Telepon" required>
                <button type="submit" class="btn btn-primary">Tambah Warga</button>
            </form>
            <div style="overflow-x: auto;">
                <table id="tableWarga">
                    <thead><tr><th>Nama</th><th>Alamat</th><th>Status</th><th>Aksi</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="pembayaran" class="section">
        <div class="card">
            <h2><i class="fas fa-money-bill-wave"></i> Pembayaran IPL</h2>
            <button class="btn btn-success" onclick="exportData('ipl')"><i class="fas fa-file-export"></i> Ekspor PDF</button>
            <form id="formIPL">
                <select id="iplNama" required><option value="">Pilih Warga</option></select>
                <input type="number" id="iplBiaya" placeholder="Biaya (Rp)" required>
                <input type="text" id="iplKet" placeholder="Keterangan (Bulan)">
                <button type="submit" class="btn btn-primary">Catat Pembayaran</button>
            </form>
            <table id="tableIPL">
                <thead><tr><th>Nama</th><th>Biaya</th><th>Ket</th><th>Aksi</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section id="kas" class="section">
        <div class="card">
            <h2><i class="fas fa-wallet"></i> Pengeluaran Kas</h2>
            <button class="btn btn-success" onclick="exportData('kas')"><i class="fas fa-file-export"></i> Ekspor PDF</button>
            <form id="formKas">
                <select id="kasJenis">
                    <option value="Perbaikan Lampu">Perbaikan Lampu</option>
                    <option value="Perbaikan CCTV">Perbaikan CCTV</option>
                    <option value="Token Listrik">Token Listrik</option>
                </select>
                <input type="number" id="kasNominal" placeholder="Nominal" required>
                <input type="text" id="kasKet" placeholder="Keterangan">
                <button type="submit" class="btn btn-primary">Simpan</button>
            </form>
            <table id="tableKas">
                <thead><tr><th>Jenis</th><th>Nominal</th><th>Ket</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section id="cekdata" class="section">
        <div class="card">
            <h2><i class="fas fa-search"></i> Cek Status Pembayaran</h2>
            <table id="tableCek">
                <thead><tr><th>Nama</th><th>Alamat</th><th>Status IPL</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section id="komplain" class="section">
        <div class="card">
            <h2><i class="fas fa-exclamation-circle"></i> Komplain Warga</h2>
            <form id="formKomplain">
                <input type="text" id="kNama" placeholder="Nama">
                <textarea id="kKet" placeholder="Isi Komplain"></textarea>
                <button type="submit" class="btn btn-danger">Kirim Komplain</button>
            </form>
        </div>
    </section>
</main>

<nav>
    <a href="#" onclick="showSection('dashboard')" class="active"><i class="fas fa-home"></i>Dash</a>
    <a href="#" onclick="showSection('warga')"><i class="fas fa-users"></i>Warga</a>
    <a href="#" onclick="showSection('pembayaran')"><i class="fas fa-money-bill"></i>IPL</a>
    <a href="#" onclick="showSection('kas')"><i class="fas fa-wallet"></i>Kas</a>
    <a href="#" onclick="showSection('cekdata')"><i class="fas fa-tasks"></i>Cek</a>
    <a href="#" onclick="showSection('komplain')"><i class="fas fa-comment"></i>Aduan</a>
</nav>

<script>
    // --- KONFIGURASI JSONBIN.IO ---
    // Ganti dengan API KEY dan BIN ID Anda jika ingin mencoba di server sendiri
    const API_KEY = '$2a$10$3D9e6KvZfFl/TJgg7rnmVux97GY.8O2zu39QY7EdiF3pOP4PsiHH6'; // Dummy Key
    const BIN_ID ='698b9ccad0ea881f40b068a6'; 
    
    // Data Storage (Local Backup if JSONbin fails)
    let db = {
        warga: [],
        pembayaran: [],
        kas: [],
        komplain: []
    };

    // --- INISIALISASI ---
    document.addEventListener('DOMContentLoaded', () => {
        loadLocalData();
        renderAll();
        initCharts();
    });

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active-section'));
        document.getElementById(id).classList.add('active-section');
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(id === 'dashboard') initCharts();
        if(id === 'cekdata') renderCekStatus();
    }

    // --- LOGIKA DATA ---
    function renderAll() {
        // Render Warga Table
        const tbodyWarga = document.querySelector('#tableWarga tbody');
        tbodyWarga.innerHTML = '';
        const iplNamaSelect = document.getElementById('iplNama');
        iplNamaSelect.innerHTML = '<option value="">Pilih Warga</option>';

        db.warga.forEach((w, index) => {
            tbodyWarga.innerHTML += `<tr>
                <td>${w.nama}</td><td>${w.alamat}</td><td>${w.status}</td>
                <td><button onclick="deleteWarga(${index})" class="btn-danger"><i class="fas fa-trash"></i></button></td>
            </tr>`;
            iplNamaSelect.innerHTML += `<option value="${w.nama}">${w.nama} (${w.alamat})</option>`;
        });

        // Render IPL Table
        const tbodyIPL = document.querySelector('#tableIPL tbody');
        tbodyIPL.innerHTML = '';
        db.pembayaran.forEach((p, index) => {
            tbodyIPL.innerHTML += `<tr>
                <td>${p.nama}</td><td>${p.biaya}</td><td>${p.ket}</td>
                <td><button onclick="deleteIPL(${index})" class="btn-danger">Hapus</button></td>
            </tr>`;
        });

        // Render Kas Table
        const tbodyKas = document.querySelector('#tableKas tbody');
        tbodyKas.innerHTML = '';
        db.kas.forEach(k => {
            tbodyKas.innerHTML += `<tr><td>${k.jenis}</td><td>${k.nominal}</td><td>${k.ket}</td></tr>`;
        });
    }

    function renderCekStatus() {
        const tbody = document.querySelector('#tableCek tbody');
        tbody.innerHTML = '';
        db.warga.forEach(w => {
            const isLunas = db.pembayaran.find(p => p.nama === w.nama);
            tbody.innerHTML += `<tr>
                <td>${w.nama}</td>
                <td>${w.alamat}</td>
                <td><span class="badge ${isLunas ? 'badge-lunas' : 'badge-belum'}">
                    ${isLunas ? 'LUNAS' : 'BELUM BAYAR'}</span>
                </td>
            </tr>`;
        });
    }

    // --- FORM HANDLERS ---
    document.getElementById('formWarga').onsubmit = (e) => {
        e.preventDefault();
        db.warga.push({
            nama: document.getElementById('wNama').value,
            alamat: document.getElementById('wAlamat').value,
            status: document.getElementById('wStatus').value,
            telp: document.getElementById('wTelp').value
        });
        saveData();
    };

    document.getElementById('formIPL').onsubmit = (e) => {
        e.preventDefault();
        db.pembayaran.push({
            nama: document.getElementById('iplNama').value,
            biaya: document.getElementById('iplBiaya').value,
            ket: document.getElementById('iplKet').value
        });
        saveData();
    };

    document.getElementById('formKas').onsubmit = (e) => {
        e.preventDefault();
        db.kas.push({
            jenis: document.getElementById('kasJenis').value,
            nominal: document.getElementById('kasNominal').value,
            ket: document.getElementById('kasKet').value
        });
        saveData();
    };

    // --- STORAGE & JSONBIN SIMULATION ---
    function saveData() {
        localStorage.setItem('rt04_db', JSON.stringify(db));
        renderAll();
        // Simulasi update ke JSON.io
        console.log("Data Tersimpan ke Cloud (JSONbin.io Simulation)");
    }

    function loadLocalData() {
        const data = localStorage.getItem('rt04_db');
        if(data) db = JSON.parse(data);
    }

    // --- CHARTS ---
    function initCharts() {
        const lunas = db.pembayaran.length;
        const belum = db.warga.length - lunas;
        const pengeluaran = db.kas.reduce((acc, curr) => acc + parseInt(curr.nominal || 0), 0);
        
        // Bar Chart
        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: ['Lunas', 'Pengeluaran (Ribu)'],
                datasets: [{
                    label: 'IPL vs Kas',
                    data: [lunas, pengeluaran/1000],
                    backgroundColor: ['#22c55e', '#ef4444']
                }]
            }
        });

        // Pie Chart
        new Chart(document.getElementById('pieChart'), {
            type: 'pie',
            data: {
                labels: ['Lunas', 'Belum'],
                datasets: [{
                    data: [lunas, belum < 0 ? 0 : belum],
                    backgroundColor: ['#22c55e', '#cbd5e1']
                }]
            }
        });

        // Line Chart
        const tetap = db.warga.filter(w => w.status === 'Tetap').length;
        const kontrak = db.warga.filter(w => w.status === 'Kontrak').length;
        new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: ['Warga Tetap', 'Warga Kontrak'],
                datasets: [{
                    label: 'Demografi',
                    data: [tetap, kontrak],
                    borderColor: '#2563eb',
                    fill: false
                }]
            }
        });
    }

    // --- EKSPOR & IMPOR ---
    function exportData(type) {
        window.print(); // Cara termudah untuk ekspor PDF mobile-friendly
    }

    document.getElementById('importWarga').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imported = JSON.parse(e.target.result);
            db.warga = imported;
            saveData();
            alert('Data Warga Berhasil diimpor!');
        };
        reader.readAsText(e.target.files[0]);
    };

    function deleteWarga(index) { db.warga.splice(index, 1); saveData(); }
    function deleteIPL(index) { db.pembayaran.splice(index, 1); saveData(); }
</script>

</body>
</html>
